# Crear y configurar stack de tráfico externo público

[![en](https://img.shields.io/badge/lang-en-blue.svg)](Create%20and%20configure%20public%20external%20traffic%20stack.md)
[![es](https://img.shields.io/badge/lang-es-blue.svg)](Create%20and%20configure%20public%20external%20traffic%20stack.es.md)

Configuraremos el stack de Docker de tráfico público; configuraremos el cortafuegos para permitir los puertos necesarios; y levantaremos el stack a través de Portainer; haremos Port Forwarding de los puertos HTTP y HTTPS para Nginx; configuraremos Nginx para redireccionar el tráfico a los contenedores; y permitiremos a Nginx actuar como proxy de Home Assistant. El stack consiste de los siguientes contenedores:

- Nginx Proxy Manager: Motor y administrador de Reverse Proxy.

## Pasos

1. Ejecutar: `./scripts/create_nginx_folder.sh` para generar el directorio del contenedor en el SSD.
2. Editar el archivo del stack: `nano ./files/public-traffic-stack.yml`.
3. Reemplazar `TZ=America/New_York` por el huso horario de su sistema. Puede usar esta lista como referencia: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones.
4. Copiar todo el contenido del archivo al portapapeles. Guardar y salir con `Ctrl + X, Y, Enter`.
5. Ejecutar: `./scripts/public_traffic_firewalld_services.sh`. Configura Firewalld para los contenedores. El script abre los puertos HTTP y HTTPS para Nginx.
6. Agregar stack en Portainer desde el navegador.
    1. Acceder a Portainer a través de https://server.lan:9443. Si sale una alerta de seguridad, puede aceptar el riesgo ya que Portainer usa un certificado de SSL autofirmado.
    2. Darle clic en "Get Started" y luego seleccionar "local".
    3. Seleccionar "Stacks" y crear un nuevo stack.
    4. Ponerle nombre "public-traffic" y pegar el contenido del public-traffic-stack.yml que copió al portapapeles y crear el stack. Desde ahora modificaciones al stack se deben de hacer a través de Portainer y no en el archivo.
7. Configurar el router. Si no desea exponer sus servicios al internet, brincar este paso. Cada router es diferente, así que tendrá que consultar su manual para poder hacer los pasos siguientes.
    1. Redireccionar el puerto (Port Forwarding) 80 y 443 en protocolo TCP al servidor para que Nginx pueda hacer reverse proxy a los servicios internos.
8. Configurar proxy hosts en Nginx usando el DDNS.
    1. Acceder a Nginx a través de http://server.lan:8181.
    2. Usar `admin@example.com` y `changeme` como usuario y contraseña y modificar los detalles y contraseña por una segura. Se recomienda nuevamente el uso de Bitwarden para lo mismo.
    3. Navegar a la pestaña de `SSL Certificates`.
    4. Presionar `Add SSL Certificate`. Seleccionar `Let's Encrypt` como proveedor de certificados.
        1. Configurar un certificado SSL de "dominio comodín" con Let's Encrypt. Por ejemplo `*.micasa.duckdns.org` (note el `*` al principio del dominio).
        2. Es necesario habilitar `Usar DNS Challenge`.
        3. Seleccionar DuckDNS como proveedor DNS.
        4. Reemplazar `your-duckdns-token` por el token que generó en DuckDNS.org
        5. Aceptar los términos del servicio y guardar.
    5. Navegar a la pestaña de "Access List" y configurar una lista de acceso privado.
        1. Presionar `Add Access List`.
        2. En la pestaña `Details` llenar:
            - "Name": Private.
            - "Pass Auth to Host": habilitado.
        3. En la pestaña `Access` llenar:
            - allow: 192.168.1.0/24. Usar el rango de IPs de su LAN si es diferente.
        4. Darle clic en `Save`.
    6. Navegar a la pestaña de "Proxy Hosts" y configurar todos los proxy host que necesitaremos. Por el momento, solo los servicios de Cockpit, Portainer y Nginx existen. Los demás los crearemos después.
        1. Por cada fila en la tabla de abajo, darle clic en `Add Proxy Host` y llenar los datos. Si no quiere compartir un servicio en el internet, puede usar el "Access List" `Private` en vez de `Public`. En la pestaña de `SSL` siempre escoger `*.micasa.duckdns.org` creado en el paso 4 como `SSL certificate` y habilitar todas las opciones.

    |    Servicio    |              Domain              | Scheme |   Hostname    | Port | Block Exploits | Websockets | Access List | Advanced                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
    |:--------------:|:--------------------------------:|:------:|:-------------:|:----:|:--------------:|:----------:|:-----------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    |     Bazarr     |    bazarr.micasa.duckdns.org     |  http  |    bazarr     | 6767 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Cockpit     |    cockpit.micasa.duckdns.org    | https  |  172.21.0.1   | 9090 |    activado    |  activado  |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |  Flaresolverr  | flaresolverr.micasa.duckdns.org  |  http  | flaresolverr  | 8191 |    activado    |  activado  |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Gotify     |    gotify.micasa.duckdns.org     |  http  |    gotify     |  80  |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    | Home Assistant | homeassistant.micasa.duckdns.org |  http  | homeassistant | 8123 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Jellyfin    |   jellyfin.micasa.duckdns.org    |  http  |   jellyfin    | 8096 |    activado    |  activado  |   Public    | <pre><code># Disable buffering when the nginx proxy gets very resource heavy upon streaming<br>proxy_buffering off;<br># Proxy main Jellyfin traffic<br>proxy_set_header X-Real-IP \$remote_addr;<br>proxy_set_header X-Forwarded-Protocol \$scheme;<br>proxy_set_header X-Forwarded-Host $http_host;<br>proxy_headers_hash_max_size 2048;<br>proxy_headers_hash_bucket_size 128;<br># Security / XSS Mitigation Headers<br># NOTE: X-Frame-Options may cause issues with the webOS app<br>add_header X-Frame-Options "SAMEORIGIN";<br>add_header X-XSS-Protection "0";<br>add_header X-Content-Type-Options "nosniff";</code></pre> |
    |   Jellyseerr   |  jellyseerr.micasa.duckdns.org   |  http  |  jellyseerr   | 5055 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |   Nextcloud    |   nextcloud.micasa.duckdns.org   |  http  |   nextcloud   |  80  |    activado    |  activado  |   Public    | <pre><code>client_body_buffer_size 512k;<br>proxy_read_timeout 86400s;<br>client_max_body_size 0;</code></pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
    |      NPM       |     nginx.micasa.duckdns.org     |  http  |   127.0.0.1   |  81  |    activado    |  activado  |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |   Portainer    |   portainer.micasa.duckdns.org   | https  |   portainer   | 9443 |    activado    |  activado  |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Prowlarr    |   prowlarr.micasa.duckdns.org    |  http  |   prowlarr    | 9696 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |  qBittorrent   |  qbittorrent.micasa.duckdns.org  |  http  |  qbittorrent  | 8080 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Radarr     |    radarr.micasa.duckdns.org     |  http  |    radarr     | 7878 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Sonarr     |    sonarr.micasa.duckdns.org     |  http  |    sonarr     | 8989 |    activado    |  activado  |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

9. Puede probar que Nginx funciona accediendo a si mismo a través del URL con su subdominio: https://nginx.micasa.duckdns.org. Inténtelo desde adentro de su red local para probar el "split horizon DNS" y desde afuera para probar el DDNS. Desde afuera, debería recibir un error `403 Forbidden`.
10. De regreso en Portainer, modificar el stack `public-traffic` que acabamos de crear.
    1. Debajo de `ports`, borrar o comentar el mapeo `8181:81`. Ahora podemos accesarlo a través del dominio.
    2. Darle clic en `Update the stack`.
11. Modificar el stack de portainer: `nano /Apps/portainer-stack.yml`.
    1. Borrar o comentar la sección entera de `ports`. Ahora podemos accesarlo a través del dominio.
    2. Guardar y salir con `Ctrl + X, Y, Enter`.
    3. Actualizar el stack después de los cambios: `docker compose -f /Apps/portainer-stack.yml up -d`.

[<img width="33.3%" src="buttons/prev-Configure dns.es.svg" alt="Configurar DNS">](Configure%20dns.es.md)[<img width="33.3%" src="buttons/jump-Index.es.svg" alt="Índice">](README.es.md)[<img width="33.3%" src="buttons/next-Create and configure nextcloud stack.es.svg" alt="Crear y configurar stack de Nextcloud">](Create%20and%20configure%20nextcloud%20stack.es.md)
