# Create and configure public external traffic stack

[![en](https://img.shields.io/badge/lang-en-blue.svg)](Create%20and%20configure%20public%20external%20traffic%20stack.md)
[![es](https://img.shields.io/badge/lang-es-blue.svg)](Create%20and%20configure%20public%20external%20traffic%20stack.es.md)

We will configure the public traffic Docker stack; we will configure the firewall to allow the necessary ports; we will bring the stack up through Portainer; we will do Port Forwarding of the HTTP and HTTPS ports for Nginx; we will configure Nginx to redirect traffic to the containers; and we will allow Nginx to act as a proxy for Home Assistant. The stack consists of the following containers:

- Nginx Proxy Manager: Reverse Proxy engine and manager.

## Steps

1. Run: `./scripts/create_nginx_folder.sh` to generate the container directory on the SSD.
2. Edit the stack file: `nano ./files/public-traffic-stack.yml`.
3. Replace `TZ=America/New_York` with your system time zone. You can use this list as a reference: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones.
4. Copy all contents of the file to the clipboard. Save and exit with `Ctrl + X, Y, Enter`.
5. Run: `./scripts/public_traffic_firewalld_services.sh`. Configure Firewalld for containers. The script opens the ports for HTTP and HTTPS for Nginx.
6. Add stack in Portainer from the browser.
    1. Access Portainer through https://server.lan:9443. If you get a security alert, you can accept the risk since Portainer uses a self-signed SSL certificate.
    2. Click "Get Started" and then select "local."
    3. Select "Stacks" and create a new stack.
    4. Name it "public-traffic" and paste the content of the public-traffic-stack.yml that you copied to the clipboard and create the stack. From now on, modifications to the stack must be made through Portainer and not in the file.
7. Configure the router. If you don't want to expose your services to the internet, skip this step. Each router is different, so you will have to consult your manual to be able to do the following steps.
    1. Forward port 80 and 443 in TCP protocol to the server so that Nginx can reverse proxy the internal services.
8. Configure proxy hosts in Nginx using DDNS.
    1. Access Nginx through http://server.lan:8181.
    2. Use ` admin@example.com ` and `changeme` as username and password and change the details and password to a secure one. It is again recommended to use Bitwarden for the same.
    3. Navigate to the `SSL Certificates` tab.
    4. Press `Add SSL Certificate`. Select `Let's Encrypt` as certificate provider.
        1. Set up a wildcard domain SSL certificate with Let's Encrypt. For example `*.myhome.duckdns.org` (note the `*` at the beginning of the domain).
        2. You need to enable `Use DNS Challenge`.
        3. Select DuckDNS as the DNS provider.
        4. Replace `your-duckdns-token` with the token you generated on DuckDNS.org
        5. Accept the terms of service and save.
    5. Navigate to the "Access List" tab and configure a private access list.
        1. Press `Add Access List`.
        2. In the `Details` tab fill out:
            - "Name": Private.
            - "Pass Auth to Host": enabled.
        3. In the `Access` tab fill out:
            - allow: 192.168.1.0/24. Use your LAN IP range if different.
        4. Click `Save`.
    6. Navigate to the “Proxy Hosts” tab and configure all the proxy hosts we will need. For now, only the Cockpit, Portainer and Nginx services exist. The rest will be created later.
        1. For each row in the table below, click `Add Proxy Host` and fill the data. If you don't want to share a service to the internet, you can use the `Private` "Access List" instead of `Public`. In the `SSL` tab always choose `*.myhome.duckdns.org` as `SSL certificate` and enable all options.

    |    Service     |              Domain              | Scheme |   Hostname    | Port | Block Exploits | Websockets | Access List | Advanced                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
    |:--------------:|:--------------------------------:|:------:|:-------------:|:----:|:--------------:|:----------:|:-----------:|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    |     Bazarr     |    bazarr.myhome.duckdns.org     |  http  |    bazarr     | 6767 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Cockpit     |    cockpit.myhome.duckdns.org    | https  |  172.21.0.1   | 9090 |    enabled     |  enabled   |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |  Flaresolverr  | flaresolverr.myhome.duckdns.org  |  http  | flaresolverr  | 8191 |    enabled     |  enabled   |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Gotify     |    gotify.myhome.duckdns.org     |  http  |    gotify     |  80  |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    | Home Assistant | homeassistant.myhome.duckdns.org |  http  | homeassistant | 8123 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Jellyfin    |   jellyfin.myhome.duckdns.org    |  http  |   jellyfin    | 8096 |    enabled     |  enabled   |   Public    | <pre><code># Disable buffering when the nginx proxy gets very resource heavy upon streaming<br>proxy_buffering off;<br># Proxy main Jellyfin traffic<br>proxy_set_header X-Real-IP \$remote_addr;<br>proxy_set_header X-Forwarded-Protocol \$scheme;<br>proxy_set_header X-Forwarded-Host $http_host;<br>proxy_headers_hash_max_size 2048;<br>proxy_headers_hash_bucket_size 128;<br># Security / XSS Mitigation Headers<br># NOTE: X-Frame-Options may cause issues with the webOS app<br>add_header X-Frame-Options "SAMEORIGIN";<br>add_header X-XSS-Protection "0";<br>add_header X-Content-Type-Options "nosniff";</code></pre> |
    |   Jellyseerr   |  jellyseerr.myhome.duckdns.org   |  http  |  jellyseerr   | 5055 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |   Nextcloud    |   nextcloud.myhome.duckdns.org   |  http  |   nextcloud   |  80  |    enabled     |  enabled   |   Public    | <pre><code>client_body_buffer_size 512k;<br>proxy_read_timeout 86400s;<br>client_max_body_size 0;</code></pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
    |      NPM       |     nginx.myhome.duckdns.org     |  http  |   127.0.0.1   |  81  |    enabled     |  enabled   |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |   Portainer    |   portainer.myhome.duckdns.org   | https  |   portainer   | 9443 |    enabled     |  enabled   |   Private   | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |    Prowlarr    |   prowlarr.myhome.duckdns.org    |  http  |   prowlarr    | 9696 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |  qBittorrent   |  qbittorrent.myhome.duckdns.org  |  http  |  qbittorrent  | 8080 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Radarr     |    radarr.myhome.duckdns.org     |  http  |    radarr     | 7878 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    |     Sonarr     |    sonarr.myhome.duckdns.org     |  http  |    sonarr     | 8989 |    enabled     |  enabled   |   Public    | N/A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

9. You can test that Nginx works by accessing itself through the URL with its subdomain: https://nginx.myhome.duckdns.org. Try it from inside your local network to test split horizon DNS and from outside to test DDNS. From outside, you should get a `403 Forbidden` error.
10. Back in Portainer, edit the `public-traffic` stack we just created.
    1. Under `ports`, delete or comment out the `8181:81` mapping. We can now access it through the domain.
    2. Click `Update the stack`.
11. Modify the portainer stack: `nano /Apps/portainer-stack.yml`.
    1. Delete or comment out the entire `ports` section. We can now access it through the domain.
    2. Save and exit with `Ctrl + X, Y, Enter`.
    3. Update the stack after the changes: `docker compose -f /Apps/portainer-stack.yml up -d`.

[<img width="33.3%" src="buttons/prev-Configure dns.svg" alt="Configure DNS">](Configure%20dns.md)[<img width="33.3%" src="buttons/jump-Index.svg" alt="Index">](README.md)[<img width="33.3%" src="buttons/next-Create and configure nextcloud stack.svg" alt="Create and configure Nextcloud stack">](Create%20and%20configure%20nextcloud%20stack.md)
